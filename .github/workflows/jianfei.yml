name: Build Android APK
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python and dependencies
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip \
          build-essential \
          git \
          zip \
          unzip \
          openjdk-11-jdk \
          zlib1g-dev \
          autoconf \
          automake \
          libtool \
          libtool-bin \
          pkg-config \
          cmake \
          libffi-dev \
          libssl-dev \
          wget \
          curl
        
    - name: Install Buildozer and requirements
      run: |
        pip install buildozer
        pip install cython==0.29.33
        pip install kivy==2.1.0 kivymd==1.1.1 peewee
        
    - name: Verify required files exist
      run: |
        echo "æ£€æŸ¥å¿…è¦æ–‡ä»¶..."
        required_files=("buildozer.spec" "fonts/simkai.ttf" "data/icon.png" "main.py")
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ä¸å­˜åœ¨"
            exit 1
          fi
        done
        echo "æ‰€æœ‰å¿…è¦æ–‡ä»¶æ£€æŸ¥é€šè¿‡ï¼"
        
    - name: Initialize Buildozer and install Android SDK tools
      run: |
        echo "åˆå§‹åŒ– Buildozer å¹¶å®‰è£… Android SDK å·¥å…·..."
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
        export PATH=$JAVA_HOME/bin:$PATH
        
        # åˆå§‹åŒ– Buildozerï¼ˆè¿™ä¼šåˆ›å»º .buildozer ç›®å½•ï¼‰
        buildozer init || true
        
        # ç¡®ä¿ Buildozer çš„ Android SDK ç›®å½•å­˜åœ¨
        mkdir -p ~/.buildozer/android/platform/android-sdk
        
        # æ¥å— Android SDK è®¸å¯è¯
        mkdir -p ~/.android/licenses
        echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > ~/.android/licenses/android-sdk-license
        echo "84831b9409646a918e30573bab4c9c91346d8abd" > ~/.android/licenses/android-sdk-preview-license
        echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> ~/.android/licenses/android-sdk-license
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" >> ~/.android/licenses/android-sdk-license
        
        # ä¸‹è½½å¹¶å®‰è£… Android SDK å‘½ä»¤è¡Œå·¥å…·åˆ° Buildozer çš„ç›®å½•
        SDK_DIR="$HOME/.buildozer/android/platform/android-sdk"
        cd $SDK_DIR
        
        # ä¸‹è½½å‘½ä»¤è¡Œå·¥å…·
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
        unzip -q cmdline-tools.zip
        rm cmdline-tools.zip
        
        # åˆ›å»ºæ­£ç¡®çš„ç›®å½•ç»“æ„
        mkdir -p cmdline-tools
        mv tools cmdline-tools/latest
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export ANDROID_SDK_ROOT=$SDK_DIR
        export PATH=$SDK_DIR/cmdline-tools/latest/bin:$PATH
        
        echo "å®‰è£… Build-Tools (åŒ…å« aidl)..."
        # å®‰è£… build-tools
        yes | sdkmanager --sdk_root=$ANDROID_SDK_ROOT "build-tools;34.0.0"
        
        echo "å®‰è£… Platform Tools..."
        yes | sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platform-tools"
        
        echo "å®‰è£… Android Platform..."
        yes | sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platforms;android-34"
        
        echo "Android SDK å·¥å…·å®‰è£…å®Œæˆ"
        
    - name: Verify AIDL tool exists
      run: |
        echo "éªŒè¯ AIDL å·¥å…·æ˜¯å¦å­˜åœ¨..."
        SDK_DIR="$HOME/.buildozer/android/platform/android-sdk"
        
        # æŸ¥æ‰¾ aidl å·¥å…·
        if find $SDK_DIR -name "aidl" -type f 2>/dev/null | grep -q .; then
          echo "âœ… AIDL å·¥å…·å·²æ‰¾åˆ°:"
          find $SDK_DIR -name "aidl" -type f
        else
          echo "âŒ AIDL å·¥å…·æœªæ‰¾åˆ°"
          echo "æ£€æŸ¥ build-tools ç›®å½•:"
          ls -la $SDK_DIR/build-tools/ || echo "build-tools ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
    - name: Build APK with Buildozer
      run: |
        echo "å¼€å§‹æ„å»º APK..."
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
        export ANDROID_SDK_ROOT="$HOME/.buildozer/android/platform/android-sdk"
        export PATH=$JAVA_HOME/bin:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH
        
        # æ¸…ç†ä¹‹å‰çš„æ„å»º
        buildozer android clean || true
        
        echo "å¼€å§‹æ­£å¼æ„å»º..."
        # ä½¿ç”¨æ›´é•¿çš„è¶…æ—¶æ—¶é—´
        timeout 3600 buildozer -v android debug
      continue-on-error: true
      
    - name: Check if APK exists
      id: check_apk
      run: |
        if find bin/ -name "*.apk" 2>/dev/null | grep -q .; then
          echo "apk_exists=true" >> $GITHUB_OUTPUT
          APK_FILE=$(find bin/ -name "*.apk" | head -1)
          echo "APKæ–‡ä»¶æ‰¾åˆ°: $APK_FILE"
          echo "APKæ–‡ä»¶å¤§å°: $(du -h "$APK_FILE" | cut -f1)"
          echo "ğŸ‰ APKæ„å»ºæˆåŠŸï¼"
        else
          echo "apk_exists=false" >> $GITHUB_OUTPUT
          echo "æœªæ‰¾åˆ°APKæ–‡ä»¶"
          echo "æ£€æŸ¥æ„å»ºçŠ¶æ€..."
          if [ -d ".buildozer" ]; then
            echo "æ„å»ºç›®å½•å­˜åœ¨ï¼Œæ£€æŸ¥æ—¥å¿—..."
            find .buildozer -name "*.log" -exec echo "=== {} ===" \; -exec tail -30 {} \; 2>/dev/null | head -150 || echo "æ— æ—¥å¿—æ–‡ä»¶"
          else
            echo "æ„å»ºç›®å½•ä¸å­˜åœ¨"
          fi
        fi
        
    - name: Upload APK artifact
      if: steps.check_apk.outputs.apk_exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: jianfei-app-apk
        path: bin/*.apk
        retention-days: 30
        
    - name: Upload build logs
      if: steps.check_apk.outputs.apk_exists == 'false'
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          .buildozer/
        retention-days: 30
        
    - name: Final status report
      run: |
        if [ "${{ steps.check_apk.outputs.apk_exists }}" = "true" ]; then
          echo "ğŸ‰ æ­å–œï¼APKæ„å»ºæˆåŠŸï¼"
          echo "ğŸ“± å¯åœ¨Artifactsä¸­ä¸‹è½½APKæ–‡ä»¶"
          echo "âœ… æ‰€æœ‰é—®é¢˜å·²è§£å†³ï¼"
        else
          echo "ğŸ’¥ APKæ„å»ºå¤±è´¥"
          echo "ğŸ” è¯·æŸ¥çœ‹æ„å»ºæ—¥å¿—äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          echo "ğŸ’¡ å»ºè®®ï¼šå°è¯•åœ¨æœ¬åœ°ç¯å¢ƒä¸­ä½¿ç”¨ç›¸åŒé…ç½®æ„å»º"
        fi
