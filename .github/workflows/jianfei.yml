name: Build Android APK
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install Android SDK and build tools
      run: |
        sudo apt-get update
        # å®‰è£…åŸºç¡€æ„å»ºå·¥å…·å’ŒAndroid SDK
        sudo apt-get install -y \
          python3-pip \
          build-essential \
          git \
          zip \
          unzip \
          openjdk-11-jdk \
          zlib1g-dev \
          wget
        
        # å®‰è£… Android SDK å‘½ä»¤è¡Œå·¥å…·
        wget https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip
        mkdir -p android-sdk
        unzip commandlinetools-linux-8512546_latest.zip -d android-sdk
        rm commandlinetools-linux-8512546_latest.zip
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "ANDROID_HOME=$PWD/android-sdk" >> $GITHUB_ENV
        echo "PATH=$PWD/android-sdk/cmdline-tools/bin:$PATH" >> $GITHUB_ENV
        
    - name: Install Buildozer and Cython
      run: |
        # å…ˆå®‰è£… Cythonï¼Œè¿™æ˜¯ Buildozer çš„ä¾èµ–
        pip install cython==0.29.33
        # å†å®‰è£… Buildozer
        pip install buildozer
        echo "$(python -m site --user-base)/bin" >> $GITHUB_PATH
        
    - name: Fix buildozer.spec configuration
      run: |
        echo "ä¿®å¤ buildozer.spec é…ç½®å†²çª..."
        echo "åŸå§‹æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
        head -30 buildozer.spec
        
        # å¤‡ä»½åŸæ–‡ä»¶
        cp buildozer.spec buildozer.spec.backup
        
        # ç§»é™¤å†²çªçš„ç‰ˆæœ¬é…ç½® - åªä¿ç•™ç®€å•çš„ç‰ˆæœ¬å·
        # åˆ é™¤ version.regex å’Œ version.filename è¡Œ
        sed -i '/version.regex/d' buildozer.spec
        sed -i '/version.filename/d' buildozer.spec
        
        echo "ä¿®å¤åçš„ buildozer.spec ç›¸å…³å†…å®¹:"
        grep -A2 -B2 "version" buildozer.spec || echo "æ²¡æœ‰æ‰¾åˆ°versionç›¸å…³é…ç½®"
        
    - name: Verify required files exist
      run: |
        echo "æ£€æŸ¥å¿…è¦æ–‡ä»¶..."
        required_files=("buildozer.spec" "fonts/simkai.ttf" "data/icon.png" "main.py")
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ä¸å­˜åœ¨"
            exit 1
          fi
        done
        echo "æ‰€æœ‰å¿…è¦æ–‡ä»¶æ£€æŸ¥é€šè¿‡ï¼"
        
    - name: Build APK with Buildozer
      run: |
        echo "å¼€å§‹æ„å»ºAPK..."
        
        # è®¾ç½® Buildozer ä½¿ç”¨ç³»ç»Ÿ Android SDK
        export ANDROIDSDK="$ANDROID_HOME"
        export ANDROIDNDK="$ANDROID_HOME/ndk"
        
        # ç›´æ¥æ„å»ºAPK
        buildozer -v android debug
      continue-on-error: true
      
    - name: Check if APK exists
      id: check_apk
      run: |
        if find bin/ -name "*.apk" | grep -q .; then
          echo "apk_exists=true" >> $GITHUB_OUTPUT
          APK_FILE=$(find bin/ -name "*.apk" | head -1)
          echo "APKæ–‡ä»¶æ‰¾åˆ°: $APK_FILE"
          echo "APKæ–‡ä»¶å¤§å°: $(du -h "$APK_FILE" | cut -f1)"
        else
          echo "apk_exists=false" >> $GITHUB_OUTPUT
          echo "æœªæ‰¾åˆ°APKæ–‡ä»¶"
          echo "æ£€æŸ¥æ„å»ºæ—¥å¿—..."
          find .buildozer -name "*.log" -exec echo "=== {} ===" \; -exec head -50 {} \; 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°æ—¥å¿—æ–‡ä»¶"
        fi
        
    - name: Upload APK artifact
      if: steps.check_apk.outputs.apk_exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: jianfei-app-apk
        path: bin/*.apk
        retention-days: 30
        
    - name: Upload build logs
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          .buildozer/
          bin/
        retention-days: 30
        
    - name: Final status report
      run: |
        if [ "${{ steps.check_apk.outputs.apk_exists }}" = "true" ]; then
          echo "ğŸ‰ APKæ„å»ºæˆåŠŸï¼"
          echo "ğŸ“± å¯åœ¨Artifactsä¸­ä¸‹è½½APKæ–‡ä»¶"
        else
          echo "ğŸ’¥ APKæ„å»ºå¤±è´¥"
          echo "ğŸ” è¯·æŸ¥çœ‹æ„å»ºæ—¥å¿—äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯"
        fi
