name: Build Android APK
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Verify required files exist
      run: |
        echo "æ£€æŸ¥å¿…è¦æ–‡ä»¶..."
        required_files=("buildozer.spec" "fonts/simkai.ttf" "data/icon.png" "main.py")
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ä¸å­˜åœ¨"
            exit 1
          fi
        done
        echo "æ‰€æœ‰å¿…è¦æ–‡ä»¶æ£€æŸ¥é€šè¿‡ï¼"
        
    - name: Build APK with optimized configuration
      run: |
        echo "ä½¿ç”¨ä¼˜åŒ–çš„é…ç½®æ„å»º APK..."
        
        # ä½¿ç”¨æ›´æ–°çš„ Ubuntu ç‰ˆæœ¬å¹¶ç¡®ä¿åŒ…åˆ—è¡¨æ­£ç¡®æ›´æ–°
        docker run --rm \
          --volume "$(pwd)":/home/user/hostcwd \
          --workdir /home/user/hostcwd \
          --env DEBIAN_FRONTEND=noninteractive \
          --env BUILDOZER_ALLOW_ROOT=1 \
          ubuntu:22.04 /bin/bash -c "
            # é¦–å…ˆæ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£…åŸºç¡€å·¥å…·
            apt-get update && apt-get install -y --no-install-recommends \
              ca-certificates \
              curl \
              gnupg \
              lsb-release
            
            # æ·»åŠ å®˜æ–¹ Ubuntu è½¯ä»¶æº
            echo 'deb http://archive.ubuntu.com/ubuntu jammy main restricted universe multiverse' > /etc/apt/sources.list
            echo 'deb http://archive.ubuntu.com/ubuntu jammy-updates main restricted universe multiverse' >> /etc/apt/sources.list
            echo 'deb http://archive.ubuntu.com/ubuntu jammy-security main restricted universe multiverse' >> /etc/apt/sources.list
            
            # å†æ¬¡æ›´æ–°åŒ…åˆ—è¡¨
            apt-get update
            
            # å®‰è£…æ‰€æœ‰å¿…è¦çš„åŒ…
            apt-get install -y --no-install-recommends \
              python3 \
              python3-pip \
              build-essential \
              git \
              zip \
              unzip \
              openjdk-11-jdk \
              zlib1g-dev \
              autoconf \
              automake \
              libtool \
              pkg-config \
              cmake \
              libffi-dev \
              libssl-dev \
              wget
            
            # æ¸…ç†ç¼“å­˜
            apt-get clean && rm -rf /var/lib/apt/lists/*

            # è®¾ç½® JAVA_HOME ç¯å¢ƒå˜é‡
            export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
            export PATH=\$JAVA_HOME/bin:\$PATH

            # å®‰è£… Buildozer å’Œä¾èµ–
            python3 -m pip install --upgrade pip
            python3 -m pip install buildozer cython==0.29.33

            # æ¥å— Android SDK è®¸å¯è¯
            mkdir -p /root/.android
            mkdir -p /root/.android/licenses
            echo '8933bad161af4178b1185d1a37fbf41ea5269c55' > /root/.android/licenses/android-sdk-license
            echo '84831b9409646a918e30573bab4c9c91346d8abd' > /root/.android/licenses/android-sdk-preview-license

            # ä¿®å¤ buildozer.spec é…ç½®
            echo 'ä¿®å¤ buildozer.spec é…ç½®...'
            
            # å¤‡ä»½åŸæ–‡ä»¶
            cp buildozer.spec buildozer.spec.backup
            
            # ç§»é™¤å†²çªçš„ç‰ˆæœ¬é…ç½®
            sed -i '/version.regex/d' buildozer.spec
            sed -i '/version.filename/d' buildozer.spec
            
            # ä½¿ç”¨æ›´ç¨³å®šçš„ä¾èµ–ç‰ˆæœ¬
            sed -i 's/kivy==2.3.0/kivy==2.1.0/g' buildozer.spec
            sed -i 's/kivymd==1.2.0/kivymd==1.1.1/g' buildozer.spec
            
            # æ·»åŠ å¿…è¦çš„é…ç½®
            if ! grep -q 'android.arch' buildozer.spec; then
              echo 'android.arch = armeabi-v7a' >> buildozer.spec
            fi
            
            # æ˜¾ç¤ºä¿®å¤åçš„é…ç½®
            echo 'ä¿®å¤åçš„ buildozer.spec ç›¸å…³å†…å®¹:'
            grep -E '(version|requirements|android\.)' buildozer.spec || echo 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³é…ç½®'

            # å¼€å§‹æ„å»º - å¢åŠ è¶…æ—¶å’Œé‡è¯•
            echo 'å¼€å§‹æ„å»º APK...'
            yes | buildozer -v android debug || \
            (echo 'ç¬¬ä¸€æ¬¡æ„å»ºå¤±è´¥ï¼Œå°è¯•æ¸…ç†åé‡æ–°æ„å»º...' && \
             buildozer android clean && \
             yes | buildozer -v android debug)
          "
      continue-on-error: true
      
    - name: Check if APK exists
      id: check_apk
      run: |
        if find bin/ -name "*.apk" | grep -q .; then
          echo "apk_exists=true" >> $GITHUB_OUTPUT
          APK_FILE=$(find bin/ -name "*.apk" | head -1)
          echo "APKæ–‡ä»¶æ‰¾åˆ°: $APK_FILE"
          echo "APKæ–‡ä»¶å¤§å°: $(du -h "$APK_FILE" | cut -f1)"
          echo "APKè¯¦ç»†ä¿¡æ¯:"
          file "$APK_FILE"
        else
          echo "apk_exists=false" >> $GITHUB_OUTPUT
          echo "æœªæ‰¾åˆ°APKæ–‡ä»¶"
          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -la
          echo "binç›®å½•å†…å®¹:"
          ls -la bin/ 2>/dev/null || echo "binç›®å½•ä¸å­˜åœ¨"
          echo "æ„å»ºæ—¥å¿—:"
          find .buildozer -name "*.log" -exec echo "=== {} ===" \; -exec head -100 {} \; 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°æ—¥å¿—æ–‡ä»¶"
        fi
        
    - name: Upload APK artifact
      if: steps.check_apk.outputs.apk_exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: jianfei-app-apk
        path: bin/*.apk
        retention-days: 30
        
    - name: Upload build logs
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          .buildozer/
          bin/
        retention-days: 30
        
    - name: Final status report
      run: |
        if [ "${{ steps.check_apk.outputs.apk_exists }}" = "true" ]; then
          echo "ğŸ‰ APKæ„å»ºæˆåŠŸï¼"
          echo "ğŸ“± å¯åœ¨Artifactsä¸­ä¸‹è½½APKæ–‡ä»¶"
          echo "âœ… æ‰€æœ‰é—®é¢˜å·²è§£å†³ï¼"
        else
          echo "ğŸ’¥ APKæ„å»ºå¤±è´¥"
          echo "ğŸ” è¯·æŸ¥çœ‹æ„å»ºæ—¥å¿—äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          echo "ğŸ”„ æˆ‘ä»¬ä¼šç»§ç»­ä¼˜åŒ–é…ç½®..."
        fi
