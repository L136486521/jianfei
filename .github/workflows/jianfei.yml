name: Build Android APK
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Verify required files exist
      run: |
        echo "æ£€æŸ¥å¿…è¦æ–‡ä»¶..."
        required_files=("buildozer.spec" "fonts/simkai.ttf" "data/icon.png" "main.py")
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ä¸å­˜åœ¨"
            exit 1
          fi
        done
        echo "æ‰€æœ‰å¿…è¦æ–‡ä»¶æ£€æŸ¥é€šè¿‡ï¼"
        
    - name: Build APK using custom Docker
      run: |
        echo "ä½¿ç”¨è‡ªå®šä¹‰ Docker ç¯å¢ƒæ„å»º APK..."
        
        # åˆ›å»ºè‡ªå®šä¹‰ Dockerfile
        cat > Dockerfile << 'EOF'
FROM ubuntu:20.04

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    build-essential \
    git \
    zip \
    unzip \
    openjdk-11-jdk \
    zlib1g-dev \
    autoconf \
    automake \
    libtool \
    pkg-config \
    cmake \
    libffi-dev \
    libssl-dev \
    wget \
    && rm -rf /var/lib/apt/lists/*

RUN pip3 install --upgrade pip
RUN pip3 install buildozer cython==0.29.33

WORKDIR /app
EOF
        
        # æ„å»ºè‡ªå®šä¹‰é•œåƒ
        docker build -t buildozer-custom .
        
        # ä½¿ç”¨è‡ªå®šä¹‰é•œåƒæ„å»º APK
        docker run --rm \
          --volume "$(pwd)":/app \
          buildozer-custom \
          buildozer -v android debug
      continue-on-error: true
      
    - name: Check if APK exists
      id: check_apk
      run: |
        if find bin/ -name "*.apk" | grep -q .; then
          echo "apk_exists=true" >> $GITHUB_OUTPUT
          APK_FILE=$(find bin/ -name "*.apk" | head -1)
          echo "APKæ–‡ä»¶æ‰¾åˆ°: $APK_FILE"
          echo "APKæ–‡ä»¶å¤§å°: $(du -h "$APK_FILE" | cut -f1)"
        else
          echo "apk_exists=false" >> $GITHUB_OUTPUT
          echo "æœªæ‰¾åˆ°APKæ–‡ä»¶"
          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -la
          echo "binç›®å½•å†…å®¹:"
          ls -la bin/ 2>/dev/null || echo "binç›®å½•ä¸å­˜åœ¨"
        fi
        
    - name: Upload APK artifact
      if: steps.check_apk.outputs.apk_exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: jianfei-app-apk
        path: bin/*.apk
        retention-days: 30
        
    - name: Upload build logs
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          .buildozer/
          bin/
        retention-days: 30
        
    - name: Final status report
      run: |
        if [ "${{ steps.check_apk.outputs.apk_exists }}" = "true" ]; then
          echo "ğŸ‰ APKæ„å»ºæˆåŠŸï¼"
          echo "ğŸ“± å¯åœ¨Artifactsä¸­ä¸‹è½½APKæ–‡ä»¶"
        else
          echo "ğŸ’¥ APKæ„å»ºå¤±è´¥"
          echo "ğŸ” è¯·æŸ¥çœ‹æ„å»ºæ—¥å¿—äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯"
        fi
